{"componentChunkName":"component---src-templates-blog-post-js","path":"/gatsby-gdpr-compliance/","webpackCompilationHash":"633104deb9655404e0b3","result":{"data":{"site":{"siteMetadata":{"title":"🦔 ~ Erizo's Blog","author":"Erizo-dev"}},"markdownRemark":{"id":"c8ce89b8-d038-50d9-a0f3-2235aa0fa7bb","excerpt":"Google Tag Manager configuration To be fair this blog was never meant to reach a broad audience. Adding google analytics support was not on my shortlist of…","html":"<p><span\n      class=\"gatsby-resp-image-wrapper\"\n      style=\"position: relative; display: block; margin-left: auto; margin-right: auto;  max-width: 590px;\"\n    >\n      <span\n    class=\"gatsby-resp-image-background-image\"\n    style=\"padding-bottom: 66.66666666666666%; position: relative; bottom: 0; left: 0; background-image: url('data:image/jpeg;base64,/9j/2wBDABALDA4MChAODQ4SERATGCgaGBYWGDEjJR0oOjM9PDkzODdASFxOQERXRTc4UG1RV19iZ2hnPk1xeXBkeFxlZ2P/2wBDARESEhgVGC8aGi9jQjhCY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2P/wgARCAANABQDASIAAhEBAxEB/8QAFwABAQEBAAAAAAAAAAAAAAAAAAIBA//EABUBAQEAAAAAAAAAAAAAAAAAAAAC/9oADAMBAAIQAxAAAAHJ7Km0D//EABoQAAICAwAAAAAAAAAAAAAAAAABAjEDESH/2gAIAQEAAQUCySFNm2XJ0nz/xAAVEQEBAAAAAAAAAAAAAAAAAAAAEf/aAAgBAwEBPwFX/8QAFREBAQAAAAAAAAAAAAAAAAAAABH/2gAIAQIBAT8BR//EABoQAAEFAQAAAAAAAAAAAAAAAAABESAxMkH/2gAIAQEABj8CTpTmYf/EABoQAAMBAAMAAAAAAAAAAAAAAAABETEQQWH/2gAIAQEAAT8hVhiSaTvONaMWM/EPH//aAAwDAQACAAMAAAAQMD//xAAXEQEAAwAAAAAAAAAAAAAAAAAAARFh/9oACAEDAQE/ENRZ/8QAFhEBAQEAAAAAAAAAAAAAAAAAAQBB/9oACAECAQE/EByZ/8QAGxAAAgMBAQEAAAAAAAAAAAAAAREAITFBYYH/2gAIAQEAAT8QMQpngN+ci1xATDI6c6MzZuHeBDGxq+QYTZH24VP/2Q=='); background-size: cover; display: block;\"\n  ></span>\n  <img\n        class=\"gatsby-resp-image-image\"\n        alt=\"Photo by Pixabay\"\n        title=\"Photo by Pixabay\"\n        src=\"/static/eaa3ab81878abef4037dcec033d009a4/c739e/privacy.jpg\"\n        srcset=\"/static/eaa3ab81878abef4037dcec033d009a4/8ee9c/privacy.jpg 148w,\n/static/eaa3ab81878abef4037dcec033d009a4/ebbe7/privacy.jpg 295w,\n/static/eaa3ab81878abef4037dcec033d009a4/c739e/privacy.jpg 590w,\n/static/eaa3ab81878abef4037dcec033d009a4/5413e/privacy.jpg 885w,\n/static/eaa3ab81878abef4037dcec033d009a4/4efde/privacy.jpg 1180w,\n/static/eaa3ab81878abef4037dcec033d009a4/b6dc8/privacy.jpg 4752w\"\n        sizes=\"(max-width: 590px) 100vw, 590px\"\n      />\n    </span></p>\n<h2>Google Tag Manager configuration</h2>\n<p>To be fair this blog was never meant to reach a broad audience. Adding google analytics support was not on my shortlist of improvements to make to this site, but a colleague of mine was toying with Tag Manager for his site and was struggling to try to comply with EU regulations. His experiments raised my curiosity.\nBy nature a gatsby site is static and will not gather any personal information, therefore I guess the only required part to make the site compliant is a dedicated page informing the user that no personal information is collected.</p>\n<p>Before trying to tweak anything, I had to set up Google analytics.\nFrom what I have read the recommended way to include GA tags is to leverage Google Tag Manager. </p>\n<p>-The first benefit of this approach is not to expose your GA tracking Id.\nI think this is not a big deal nowadays, but being cautious does not hurt 😎</p>\n<p>-The second benefit is that it gives the site admin a hook enabling him to tweak GA’s behavior.</p>\n<h3>Opt in strategy</h3>\n<p>For your site to be Gdpr compliant, you have to explicitly make the users accept that your site sends data to third-party services on a service by service basis.\nThe easiest solution I have found in Gtm to achieve that is to add a condition to the firing trigger of your GA Tag.</p>\n<h4>The “Google Analytics Universal Analytics - gatsby” tag :</h4>\n<p><span\n      class=\"gatsby-resp-image-wrapper\"\n      style=\"position: relative; display: block; margin-left: auto; margin-right: auto;  max-width: 590px;\"\n    >\n      <span\n    class=\"gatsby-resp-image-background-image\"\n    style=\"padding-bottom: 69.70317297850562%; position: relative; bottom: 0; left: 0; background-image: url('data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAAOCAYAAAAvxDzwAAAACXBIWXMAABJ0AAASdAHeZh94AAABMElEQVQ4y52TWXKDMBBEuf/dcoV8JamYxWiXEIJOjxJ/uDDEeKq6BEJ6zNosS4H3Hl3bYhh69F2HcRzR9x3fh7qvtYZSCl3XI4SAI2tiSvA8pHhJGwtjLZwPcM5z9YQZWOfqN21MPZumaVeN4kFleYEyhIQYK2SkRwIoZcFcSlWRdS7I87yrRv/BBCzAzL+IhylNvDzjrN0BZa1eRE1ghGX4NzmGLZLv67ruagPkHhAvcEahrQW64soiGYZ/GighJ+ZwVLbmbs/OAVl1Y3TN37IsVUeAf4HT9AuU3pP+jPRYoC8VxXAVDyVXUoicMwphEv6z2hRF+tDwOcaEicCjJn7Y2I9yOHDsJNRXbBOyFMPHzPyFOrcyGbdJeUZ3QJnZkGa8vWd8X3p8fH4hcmLO6AfMgkXDesEbXQAAAABJRU5ErkJggg=='); background-size: cover; display: block;\"\n  ></span>\n  <img\n        class=\"gatsby-resp-image-image\"\n        alt=\"Gtm Ga Tag\"\n        title=\"Gtm Ga Tag\"\n        src=\"/static/255dfe979308b12a743767b9f062f0f5/b9e4f/gtm_tag.png\"\n        srcset=\"/static/255dfe979308b12a743767b9f062f0f5/cf440/gtm_tag.png 148w,\n/static/255dfe979308b12a743767b9f062f0f5/d2d38/gtm_tag.png 295w,\n/static/255dfe979308b12a743767b9f062f0f5/b9e4f/gtm_tag.png 590w,\n/static/255dfe979308b12a743767b9f062f0f5/f9b6a/gtm_tag.png 885w,\n/static/255dfe979308b12a743767b9f062f0f5/6fc51/gtm_tag.png 977w\"\n        sizes=\"(max-width: 590px) 100vw, 590px\"\n      />\n    </span></p>\n<h4>The “Test Opt In” trigger :</h4>\n<p><span\n      class=\"gatsby-resp-image-wrapper\"\n      style=\"position: relative; display: block; margin-left: auto; margin-right: auto;  max-width: 590px;\"\n    >\n      <span\n    class=\"gatsby-resp-image-background-image\"\n    style=\"padding-bottom: 62.96296296296296%; position: relative; bottom: 0; left: 0; background-image: url('data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAANCAYAAACpUE5eAAAACXBIWXMAABJ0AAASdAHeZh94AAABO0lEQVQ4y51TyU7EMBTr/38fB24ckJBom33vZpzMUBiKZqtkvVZNHD/Hr5vnGTklCDFiHEbEEJD4/ezT5VJIkGGdg7EOIcaGiQftmHgo1+Uy3USnSWKch/WhVR8TPFUaa2H5TxvDw3wjTPk2ukryDWVc2+ioVkoFSzIpJULw97f8m7CqjWx/YZvrXC4Wbtt2Fy4VkrAU+hkXvH4scNag73t6ON1NelCYcuZFACqQYF2xLAtW1qcUnghL80xJQQ8t38NjsfnPwxobqXQj8943heu6net1HAgd41PzVNh3OWcrMujVih+UveZrsWkKudAaDS3HUxad5RSJFqWHW663nEno4oy3vkBpjZ7jWCGExEh89kPL6DAKWpP2LvZJORAyNspPeHnP0FpBcHMl1rwgrU3ztipXfK9+/x29L0xJ9imq0RM1AAAAAElFTkSuQmCC'); background-size: cover; display: block;\"\n  ></span>\n  <img\n        class=\"gatsby-resp-image-image\"\n        alt=\"Gtm Ga Trigger\"\n        title=\"Gtm Ga Trigger\"\n        src=\"/static/72da3fed7f87728958622b03b8b10672/b9e4f/gtm_opt_in_trigger.png\"\n        srcset=\"/static/72da3fed7f87728958622b03b8b10672/cf440/gtm_opt_in_trigger.png 148w,\n/static/72da3fed7f87728958622b03b8b10672/d2d38/gtm_opt_in_trigger.png 295w,\n/static/72da3fed7f87728958622b03b8b10672/b9e4f/gtm_opt_in_trigger.png 590w,\n/static/72da3fed7f87728958622b03b8b10672/f9b6a/gtm_opt_in_trigger.png 885w,\n/static/72da3fed7f87728958622b03b8b10672/6bcd1/gtm_opt_in_trigger.png 891w\"\n        sizes=\"(max-width: 590px) 100vw, 590px\"\n      />\n    </span></p>\n<h4>The variable whose value has been retrieved from a first-party cookie :</h4>\n<p><span\n      class=\"gatsby-resp-image-wrapper\"\n      style=\"position: relative; display: block; margin-left: auto; margin-right: auto;  max-width: 590px;\"\n    >\n      <span\n    class=\"gatsby-resp-image-background-image\"\n    style=\"padding-bottom: 81.09452736318407%; position: relative; bottom: 0; left: 0; background-image: url('data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAAQCAYAAAAWGF8bAAAACXBIWXMAABJ0AAASdAHeZh94AAABm0lEQVQ4y52UyU7DQBBE/YnkjkAoPwBXQJAjisgPsZ8gYRcHbhzCLuFtxuuMxy66JyFEwjFKRnpqy5Yr1d3lOEWhURQFfM9DGIaI4xhJkkAphaqqUJblXDhKaTBBEMD3AytW0YNFjyOiGEyUpIjTDF4ocHZ1j5PBHY4Ht5ajPtU+1xscXTTjhDICEwiJmESfnt+wvLmH9m4Pazv7WN3uWtqdHla2ulha30Vro4PWej0ThywqaX5f1Da7m+b0cuSYHR6cX+NwzEENE8EfUW6dTywFVJYiS2gcIkSh1Xwz/HU52nAURXZBOV3neQ6ttd2i+YcawRjGGKQpuSMhvp6OhY0SUc3gjyBXPsPhEB5lUwphK2NMOVNopqCkyk60LiZt2lYN15G7Jv4uhWbIM3O/XOtu4WBPt6zIGc+PP0l2ZrEuDTTda6JWMKUvRozbj2hJXIWk4HMC6MeaqM1hlmWUPQ+RDG10JIl5Li2Ini/UMlDi4UXj1c3w+fkB1/OpHUMOChqFaqRGMCE9g8fXFO9ehjDw7aJ+Xsjpn6mJb86tt4zPli+iAAAAAElFTkSuQmCC'); background-size: cover; display: block;\"\n  ></span>\n  <img\n        class=\"gatsby-resp-image-image\"\n        alt=\"Gtm Ga Cookies variable\"\n        title=\"Gtm Ga Cookies variable\"\n        src=\"/static/1baece9c255f9af837df8cf76294fe8a/b9e4f/gtm_opt-in-cookie_variable.png\"\n        srcset=\"/static/1baece9c255f9af837df8cf76294fe8a/cf440/gtm_opt-in-cookie_variable.png 148w,\n/static/1baece9c255f9af837df8cf76294fe8a/d2d38/gtm_opt-in-cookie_variable.png 295w,\n/static/1baece9c255f9af837df8cf76294fe8a/b9e4f/gtm_opt-in-cookie_variable.png 590w,\n/static/1baece9c255f9af837df8cf76294fe8a/dae74/gtm_opt-in-cookie_variable.png 804w\"\n        sizes=\"(max-width: 590px) 100vw, 590px\"\n      />\n    </span></p>\n<h3>Anonymizing data</h3>\n<p>With this setup in place, would the site be able to let the user manage its preferences, a tiny problem would remain.</p>\n<p>By default when enabled Google Analytics when enabled eagerly retrieves some PII aka personally identifiable information from the user’s browsing your site.\nTo abide by the EU regulations the website owners have to configure the GA Tags so that GA strips out from its reports all of these PII.</p>\n<p>Google kindly provides some built-in features in GTM to help us with that.\nThe variable used to configure the GA tag, for instance, can hold a field the GA script will evaluate to further anonymize the IP ( set it to true) 😎😎</p>\n<p><span\n      class=\"gatsby-resp-image-wrapper\"\n      style=\"position: relative; display: block; margin-left: auto; margin-right: auto;  max-width: 590px;\"\n    >\n      <span\n    class=\"gatsby-resp-image-background-image\"\n    style=\"padding-bottom: 67.92079207920793%; position: relative; bottom: 0; left: 0; background-image: url('data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAAOCAYAAAAvxDzwAAAACXBIWXMAABJ0AAASdAHeZh94AAABP0lEQVQ4y6WUWY6DMBBEuf8BMr+cZHIJfjhA0BAWL9jsUOk2wWiywWgslRCmea5eIKjrGkWRI89yiFKgaRr8ZwXG1lC6glIalTHgA9qu8+r6/k8KJMFkZaBJ1lqUZQkpJfKicPfTPGOapsMKFIEYyi57OqFtW4zj+JTKTGDMy/WTAgatQE43uVwofYU8p5oKgbIo3UErdB94dyi1di+xbV7schgGJ947AnNAhgmSIXfn8zdOXyeEYejc+VQPuvNAlqYOJ0mCKIoQx7EfnxV4eGy2lKunZhx19VDDrSkdzR2PSt8Pu8DlOT4A6WqMdbXjRrxLd93jkryK80AebEWdzrLsV+A7d9aal3G+hgw01Jg0Td0nt7c4lmeV/wP6PnLO4ZKugZAKGQX8ELCgn4Sk4eY9+SC3p7bYNL3iSlmtz28Xw0XNk4refwAAAABJRU5ErkJggg=='); background-size: cover; display: block;\"\n  ></span>\n  <img\n        class=\"gatsby-resp-image-image\"\n        alt=\"Gtm Ga Variables\"\n        title=\"Gtm Ga Variables\"\n        src=\"/static/f408a04b422aeb32ad1ca2730cb64943/b9e4f/gtm_tracking_variables.png\"\n        srcset=\"/static/f408a04b422aeb32ad1ca2730cb64943/cf440/gtm_tracking_variables.png 148w,\n/static/f408a04b422aeb32ad1ca2730cb64943/d2d38/gtm_tracking_variables.png 295w,\n/static/f408a04b422aeb32ad1ca2730cb64943/b9e4f/gtm_tracking_variables.png 590w,\n/static/f408a04b422aeb32ad1ca2730cb64943/f9b6a/gtm_tracking_variables.png 885w,\n/static/f408a04b422aeb32ad1ca2730cb64943/6d51e/gtm_tracking_variables.png 1010w\"\n        sizes=\"(max-width: 590px) 100vw, 590px\"\n      />\n    </span></p>\n<p>Unfortunately, this is not enough and we have to populate some additional fields.\nThose custom fields will hold some variables of the type “Custom javascript”. They will be run before GA Tags sends the data it has collected, giving us the opportunity to :</p>\n<p>-Limit the lifetime of GA cookies to 13 months.</p>\n<div class=\"gatsby-highlight\" data-language=\"javascript\"><pre class=\"language-javascript\"><code class=\"language-javascript\"><span class=\"token keyword\">function</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">{</span>\n    <span class=\"token keyword\">try</span> <span class=\"token punctuation\">{</span>\n        <span class=\"token keyword\">var</span> ga <span class=\"token operator\">=</span> <span class=\"token punctuation\">{</span><span class=\"token punctuation\">{</span>cookie_ga<span class=\"token punctuation\">}</span><span class=\"token punctuation\">}</span><span class=\"token punctuation\">;</span>\n        <span class=\"token keyword\">var</span> ga_create<span class=\"token operator\">=</span> <span class=\"token punctuation\">(</span><span class=\"token function\">Number</span><span class=\"token punctuation\">(</span>ga<span class=\"token punctuation\">.</span><span class=\"token function\">split</span><span class=\"token punctuation\">(</span><span class=\"token string\">\".\"</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">.</span><span class=\"token function\">pop</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span><span class=\"token operator\">*</span><span class=\"token number\">1000</span><span class=\"token punctuation\">;</span>\n        <span class=\"token keyword\">var</span> sec_expire <span class=\"token operator\">=</span> <span class=\"token number\">60</span><span class=\"token operator\">*</span><span class=\"token number\">60</span><span class=\"token operator\">*</span><span class=\"token number\">24</span><span class=\"token operator\">*</span><span class=\"token number\">30</span><span class=\"token operator\">*</span><span class=\"token number\">13</span><span class=\"token operator\">*</span><span class=\"token number\">1000</span><span class=\"token punctuation\">;</span>\n        <span class=\"token keyword\">var</span> t <span class=\"token operator\">=</span> <span class=\"token keyword\">new</span> <span class=\"token class-name\">Date</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">.</span><span class=\"token function\">getTime</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n        <span class=\"token keyword\">var</span> t0 <span class=\"token operator\">=</span> <span class=\"token keyword\">new</span> <span class=\"token class-name\">Date</span><span class=\"token punctuation\">(</span>ga_create<span class=\"token punctuation\">)</span><span class=\"token punctuation\">.</span><span class=\"token function\">getTime</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n        <span class=\"token keyword\">var</span> t1 <span class=\"token operator\">=</span> t0 <span class=\"token operator\">+</span> sec_expire<span class=\"token punctuation\">;</span>\n        <span class=\"token keyword\">var</span> t_diff <span class=\"token operator\">=</span> Math<span class=\"token punctuation\">.</span><span class=\"token function\">round</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">(</span>t1<span class=\"token operator\">-</span>t<span class=\"token punctuation\">)</span><span class=\"token operator\">/</span><span class=\"token number\">1000</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n        <span class=\"token keyword\">return</span> t_diff<span class=\"token punctuation\">;</span>\n    <span class=\"token punctuation\">}</span> <span class=\"token keyword\">catch</span><span class=\"token punctuation\">(</span>e<span class=\"token punctuation\">)</span><span class=\"token punctuation\">{</span>\n        <span class=\"token keyword\">return</span> sec_expire<span class=\"token operator\">/</span><span class=\"token number\">1000</span><span class=\"token punctuation\">;</span>\n        console<span class=\"token punctuation\">.</span><span class=\"token function\">log</span><span class=\"token punctuation\">(</span>e<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n    <span class=\"token punctuation\">}</span>\n<span class=\"token punctuation\">}</span></code></pre></div>\n<p>-Strip out any other PII collected from forms for instance using Regex if need be.</p>\n<p>To do that you can find on the internet a template and tweak it to your needs/locale\nFor the Erizo-Dev-Blog there is no form, so this script is only included for reference.</p>\n<div class=\"gatsby-highlight\" data-language=\"javascript\"><pre class=\"language-javascript\"><code class=\"language-javascript\"><span class=\"token keyword\">function</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n\n    <span class=\"token keyword\">return</span> <span class=\"token keyword\">function</span><span class=\"token punctuation\">(</span><span class=\"token parameter\">model</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n        <span class=\"token comment\">// PII to strip out</span>\n        <span class=\"token keyword\">var</span> piiRegex <span class=\"token operator\">=</span> <span class=\"token punctuation\">[</span><span class=\"token punctuation\">{</span>\n            name<span class=\"token punctuation\">:</span> <span class=\"token string\">'EMAIL'</span><span class=\"token punctuation\">,</span>\n            regex<span class=\"token punctuation\">:</span> <span class=\"token regex\">/[^\\/]{4}@[^\\/]{4}/g</span>\n            <span class=\"token punctuation\">}</span><span class=\"token punctuation\">,</span><span class=\"token punctuation\">{</span>\n            name<span class=\"token punctuation\">:</span> <span class=\"token string\">'TEL'</span><span class=\"token punctuation\">,</span>\n            regex<span class=\"token punctuation\">:</span> <span class=\"token regex\">/((tel=)|(telephone=)|(phone=)|(mobile=)|(mob=))[\\d\\+\\s][^&amp;\\/\\?]+/gi</span>\n            <span class=\"token punctuation\">}</span><span class=\"token punctuation\">,</span><span class=\"token punctuation\">{</span>\n            name<span class=\"token punctuation\">:</span> <span class=\"token string\">'NAME'</span><span class=\"token punctuation\">,</span>\n            regex<span class=\"token punctuation\">:</span> <span class=\"token regex\">/((prenom=)|(nom=)|(firstname=)|(lastname=)|(surname=))[^&amp;\\/\\?]+/gi</span>\n            <span class=\"token punctuation\">}</span><span class=\"token punctuation\">]</span><span class=\"token punctuation\">;</span>\n            <span class=\"token keyword\">var</span> globalSendTaskName <span class=\"token operator\">=</span> <span class=\"token string\">'_'</span> <span class=\"token operator\">+</span> model<span class=\"token punctuation\">.</span><span class=\"token function\">get</span><span class=\"token punctuation\">(</span><span class=\"token string\">'trackingId'</span><span class=\"token punctuation\">)</span> <span class=\"token operator\">+</span> <span class=\"token string\">'_sendHitTask'</span><span class=\"token punctuation\">;</span>\n        <span class=\"token comment\">// Data that were to be sent</span>\n        <span class=\"token keyword\">var</span> originalSendTask <span class=\"token operator\">=</span> window<span class=\"token punctuation\">[</span>globalSendTaskName<span class=\"token punctuation\">]</span> <span class=\"token operator\">=</span> window<span class=\"token punctuation\">[</span>globalSendTaskName<span class=\"token punctuation\">]</span> <span class=\"token operator\">||</span> model<span class=\"token punctuation\">.</span><span class=\"token function\">get</span><span class=\"token punctuation\">(</span><span class=\"token string\">'sendHitTask'</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n        <span class=\"token keyword\">var</span> i<span class=\"token punctuation\">,</span> hitPayload<span class=\"token punctuation\">,</span> parts<span class=\"token punctuation\">,</span> val<span class=\"token punctuation\">;</span>\n\n            <span class=\"token comment\">// sendHitTask will send the Data without the filtered PII</span>\n            model<span class=\"token punctuation\">.</span><span class=\"token function\">set</span><span class=\"token punctuation\">(</span><span class=\"token string\">'sendHitTask'</span><span class=\"token punctuation\">,</span> <span class=\"token keyword\">function</span><span class=\"token punctuation\">(</span><span class=\"token parameter\">sendModel</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n            hitPayload <span class=\"token operator\">=</span> sendModel<span class=\"token punctuation\">.</span><span class=\"token function\">get</span><span class=\"token punctuation\">(</span><span class=\"token string\">'hitPayload'</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">.</span><span class=\"token function\">split</span><span class=\"token punctuation\">(</span><span class=\"token string\">'&amp;'</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n            <span class=\"token keyword\">for</span> <span class=\"token punctuation\">(</span>i <span class=\"token operator\">=</span> <span class=\"token number\">0</span><span class=\"token punctuation\">;</span> i <span class=\"token operator\">&lt;</span> hitPayload<span class=\"token punctuation\">.</span>length<span class=\"token punctuation\">;</span> i<span class=\"token operator\">++</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n                parts <span class=\"token operator\">=</span> hitPayload<span class=\"token punctuation\">[</span>i<span class=\"token punctuation\">]</span><span class=\"token punctuation\">.</span><span class=\"token function\">split</span><span class=\"token punctuation\">(</span><span class=\"token string\">'='</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n                <span class=\"token comment\">// Double-decode, to account for web server encode + analytics.js encode</span>\n                val <span class=\"token operator\">=</span> <span class=\"token function\">decodeURIComponent</span><span class=\"token punctuation\">(</span><span class=\"token function\">decodeURIComponent</span><span class=\"token punctuation\">(</span>parts<span class=\"token punctuation\">[</span><span class=\"token number\">1</span><span class=\"token punctuation\">]</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n                piiRegex<span class=\"token punctuation\">.</span><span class=\"token function\">forEach</span><span class=\"token punctuation\">(</span><span class=\"token keyword\">function</span><span class=\"token punctuation\">(</span><span class=\"token parameter\">pii</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n                <span class=\"token comment\">// Replaces données PII par \"REDACTED\" (expurgés).</span>\n                val <span class=\"token operator\">=</span> val<span class=\"token punctuation\">.</span><span class=\"token function\">replace</span><span class=\"token punctuation\">(</span>pii<span class=\"token punctuation\">.</span>regex<span class=\"token punctuation\">,</span> <span class=\"token string\">'[REDACTED '</span> <span class=\"token operator\">+</span> pii<span class=\"token punctuation\">.</span>name <span class=\"token operator\">+</span> <span class=\"token string\">']'</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span> \n            <span class=\"token punctuation\">}</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n            parts<span class=\"token punctuation\">[</span><span class=\"token number\">1</span><span class=\"token punctuation\">]</span> <span class=\"token operator\">=</span> <span class=\"token function\">encodeURIComponent</span><span class=\"token punctuation\">(</span>val<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n            hitPayload<span class=\"token punctuation\">[</span>i<span class=\"token punctuation\">]</span> <span class=\"token operator\">=</span> parts<span class=\"token punctuation\">.</span><span class=\"token function\">join</span><span class=\"token punctuation\">(</span><span class=\"token string\">'='</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n            <span class=\"token punctuation\">}</span>\n            sendModel<span class=\"token punctuation\">.</span><span class=\"token function\">set</span><span class=\"token punctuation\">(</span><span class=\"token string\">'hitPayload'</span><span class=\"token punctuation\">,</span> hitPayload<span class=\"token punctuation\">.</span><span class=\"token function\">join</span><span class=\"token punctuation\">(</span><span class=\"token string\">'&amp;'</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">,</span> <span class=\"token boolean\">true</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n            <span class=\"token comment\">// Sends data</span>\n            <span class=\"token function\">originalSendTask</span><span class=\"token punctuation\">(</span>sendModel<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span> \n        <span class=\"token punctuation\">}</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>     \n    <span class=\"token punctuation\">}</span><span class=\"token punctuation\">;</span>\n<span class=\"token punctuation\">}</span></code></pre></div>\n<p>I have taken the two samples from the <a href=\"https://www.formations-analytics.com/google-tag-manager-google-analytics-et-rgpd/\">formation-analytics</a> website which is unfortunately only available in french 🥖🥖.</p>\n<p>In the upcoming part-2 of this article, I will elaborate on how to handle the preferences and the opt-in cookie now required by our GTM.</p>","timeToRead":3,"frontmatter":{"title":"Making a Gatsby site Gdpr compliant part-1: GTM","date":"2019-12-04","description":" Setting up Google Tag Manager "}}},"pageContext":{"isCreatedByStatefulCreatePages":false,"slug":"/gatsby-gdpr-compliance/","previous":{"fields":{"slug":"/gatsby-state-theme/"},"frontmatter":{"title":"Theming a gatsby site leveraging the gatsby-browser API"}},"next":null}}}